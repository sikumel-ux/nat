<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Tiket | Mahika Trans</title>
    <link rel="stylesheet" href="stylez.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Tambahan dikit biar QR Code-nya rapi di tengah */
        .qr-wrapper {
            background: white;
            padding: 10px;
            display: inline-block;
            border-radius: 10px;
            margin-top: 15px;
        }
        #qrcode img { margin: 0 auto; }
    </style>
</head>
<body class="bg-gray-100">

<div id="loader" class="text-center mt-20 font-bold text-gray-400">LOADING TICKET...</div>

<div id="ticket-container" class="hidden max-w-md mx-auto p-4">
    <div class="bg-white rounded-[30px] shadow-xl overflow-hidden">
        
        <div class="bg-[#065084] p-8 text-center">
            <img src="logo.png" alt="Logo Mahika" class="h-16 mx-auto mb-2">
            <p class="text-white text-[10px] tracking-[4px] font-bold uppercase opacity-60">Official E-Ticket</p>
        </div>

        <div class="p-6">
            <div class="flex justify-between border-b pb-4 mb-4">
                <div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Nama Penumpang</p>
                    <p id="t-nama" class="font-bold text-blue-900 text-lg uppercase"></p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Pax</p>
                    <p id="t-kursi" class="font-bold text-blue-900 text-lg"></p>
                </div>
            </div>

            <div class="mb-4">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Armada / Bus</p>
                <p id="t-armada" class="font-bold text-gray-800"></p>
            </div>

            <div class="mb-4">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Tujuan</p>
                <p id="t-tujuan" class="font-bold text-blue-800"></p>
            </div>

            <div class="grid grid-cols-2 gap-4 border-t pt-4">
                <div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Tanggal</p>
                    <p id="t-tgl" class="font-bold text-gray-800"></p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400 font-bold uppercase">Jam Keberangkatan</p>
                    <p id="t-jam" class="font-bold text-gray-800"></p>
                </div>
            </div>

            <div class="text-center mt-6 py-6 bg-gray-50 rounded-2xl">
                <div class="qr-wrapper">
                    <div id="qrcode"></div>
                </div>
                <p class="text-[9px] font-bold text-gray-400 mt-3 uppercase tracking-widest">Scan QR Tiket</p>
            </div>

            <div class="mt-4 p-4 bg-yellow-50 rounded-2xl flex justify-between items-center border border-yellow-100">
                <span class="text-[10px] font-bold text-yellow-600 uppercase">Total Bayar</span>
                <span id="t-harga" class="font-black text-xl text-blue-900"></span>
            </div>
        </div>

        <div class="p-6 bg-gray-100 text-center">
            <p class="text-[8px] text-gray-400 uppercase font-bold">Harap lapor petugas 30 menit sebelum berangkat</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAmTAWHcHpolaIHegLceyMqExVgzufJzaU",
        authDomain: "mahika-trans.firebaseapp.com",
        projectId: "mahika-trans",
        storageBucket: "mahika-trans.firebasestorage.app",
        appId: "1:1087881066133:web:148d51c88f1de3466ecd9c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const bookingId = urlParams.get('id');

    async function loadTicket() {
        if(!bookingId) return document.getElementById('loader').innerText = "ID TIKET KOSONG";
        
        try {
            const docRef = doc(db, "bookings", bookingId);
            const snap = await getDoc(docRef);

            if (snap.exists()) {
                const d = snap.data();
                
                document.getElementById('t-nama').innerText = d.nama;
                document.getElementById('t-kursi').innerText = d.kursi + " Pax";
                document.getElementById('t-armada').innerText = d.armada;
                document.getElementById('t-tujuan').innerText = d.tujuan;
                document.getElementById('t-tgl').innerText = d.tgl;
                
                // Fix Jam Double WIB
                const jamClean = d.jam ? d.jam.replace(/WIB/gi, '').trim() : '--:--';
                document.getElementById('t-jam').innerText = jamClean + " WIB";

                // Fix Harga
                const nominal = d.harga ? parseInt(d.harga).toLocaleString('id-ID') : '0';
                document.getElementById('t-harga').innerText = "Rp " + nominal;

                // Generate QR Code
                new QRCode(document.getElementById("qrcode"), {
                    text: window.location.href,
                    width: 120,
                    height: 120
                });

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('ticket-container').classList.remove('hidden');
            } else {
                document.getElementById('loader').innerText = "TIKET TIDAK DITEMUKAN";
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    loadTicket();
</script>
</body>
</html>
